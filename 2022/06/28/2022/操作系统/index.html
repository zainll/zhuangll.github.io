<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":true,"b2t":false,"scrollpercent":true},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="[toc] 操作系统">
<meta property="og:type" content="article">
<meta property="og:title" content="操作系统">
<meta property="og:url" content="http://example.com/2022/06/28/2022/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/index.html">
<meta property="og:site_name" content="liuz">
<meta property="og:description" content="[toc] 操作系统">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20220710174724.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20220710175044.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20220717173502.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20220724171523.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20220724173718.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20220731191036.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20220731191509.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20220731192550.png">
<meta property="article:published_time" content="2022-06-27T16:47:53.000Z">
<meta property="article:modified_time" content="2022-06-27T16:53:53.000Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="Another Tag">
<meta property="article:tag" content="Computer Science">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20220710174724.png">

<link rel="canonical" href="http://example.com/2022/06/28/2022/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>操作系统 | liuz</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="liuz" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">liuz</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/28/2022/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liuz">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          操作系统
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-06-28 00:47:53 / 修改时间：00:53:53" itemprop="dateCreated datePublished" datetime="2022-06-28T00:47:53+08:00">2022-06-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tool/" itemprop="url" rel="index"><span itemprop="name">tool</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tool/2022/" itemprop="url" rel="index"><span itemprop="name">2022</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>6.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>[toc]</p>
<p>操作系统</p>
<span id="more"></span>

<h2 id="3-OS-Organization-and-System-Calls"><a href="#3-OS-Organization-and-System-Calls" class="headerlink" title="3 OS Organization and System Calls"></a>3 OS Organization and System Calls</h2><p>1.操作系统有两个基本功能：</p>
<ul>
<li>防止硬件被失控的应用程序滥用  隔离</li>
<li>向应用程序提供简单一致的机制来控制复杂而又通常大不相同的低级硬件设备</li>
</ul>
<p><img src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20220710174724.png" alt="20220710174724"></p>
<p> 隔离：隔离硬件;内存空间隔离(虚拟内存)-&gt;进程管理;防御安全<br> 隔离实现分时复用硬件资源</p>
<p> 操作系统通过几个基本的抽象概念：进程、虚拟内存和文件<br><img src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20220710175044.png" alt="20220710175044"></p>
<p>进程：操作系统对一个正在运行的程序的一种抽象，操作系统实现进程交错执行的机制称为上下文切换</p>
<p>  操作系统保持跟踪进程运行所需的所有状态信息。这种状态，也就是上下文，包括 PC 和寄存器文件的当前值，以及主存的内容</p>
<p>  系统调用会将控制权传递给操作系统</p>
<p>  从一个进程到另一个进程的转换是由操作系统内核（kernel )管理的。内核是操作系统代码常驻主存的部分</p>
<p>  读写文件，执行一条系统调用（system call)指令，将控制权传递给内核。然后内核执行被请求的操作并返回应用程序</p>
<p>  内核不是一个独立的进程。是系统管理全部进程所用代码和数据结构的集合</p>
<p> kernel和User mode。这两种模式用来隔离操作系统内核和用户应用程序，用户态和内核态通过标志位区分。<br> 用户态普通指令，内核态执行特权指令</p>
<p>RISC-V还有第三种模式称为machine mode，三级权限(user/kernel/machine)</p>
<p> 操作系统和应用程序之前的接口被称为系统调用接口(System call interface)</p>
<p>用户态与内核态切换<br>RISC-V中ECALL，ARM64中SVC，HVC？</p>
<p>宏内核与微内核<br>linux，unix宏内核，是微内核<br>怎么区分宏内核和微内核？将大部分的操作系统运行在内核之外，大部分硬件驱动不在内核是微内核。微内核跳转变多</p>
<p>XV6编译<br>XV6代码三部分：kernel、user和mkfs<br>QEMU<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/fangye945a/article/details/121962409">https://blog.csdn.net/fangye945a/article/details/121962409</a></p>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install ninja-build</span><br></pre></td></tr></tbody></table></figure>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Leo_h1104/article/details/115580753">https://blog.csdn.net/Leo_h1104/article/details/115580753</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/351865040">https://zhuanlan.zhihu.com/p/351865040</a></p>
<h2 id="Page-Table"><a href="#Page-Table" class="headerlink" title="Page Table"></a>Page Table</h2><p> 虚拟内存-页表</p>
<ol>
<li><p>映射：虚拟地址&lt;–&gt;物理地址  </p>
</li>
<li><p>地址空间(Address Spaces)<br>虚拟地址空间-&gt;内存隔离</p>
</li>
<li><p>物理内存如何比虚拟内存大？实际程序运行时并不全部加载指令和数据，而是用时加载或者局部加载，所以并不需要加载全部虚拟地址空间，也不需要使用全部物理地址。但是虚拟地址需要有对应的物理地址，是一一对应的吗？如果虚拟地址更大，对应的物理地址数据会刷回到硬盘吗？即内存是硬盘的缓存</p>
</li>
<li><p>kalloc保存了空余page的列表，列表为空或者耗尽，kalloc会返回一个空指针，内核会妥善处理并将结果返回给用户应用程序。并告诉用户应用程序，要么是对这个应用程序没有额外的内存了，要么是整个机器都没有内存</p>
</li>
<li><p>实现地址空间-&gt;页表<br>页表是在硬件中通过处理器和内存管理单元(Memory Management Unit)实现</p>
</li>
<li><p>任何带有地址的指令，其中的地址应该认为是虚拟内存地址而不是物理地址</p>
</li>
<li><p>CPU角度，一旦MMU打开，它执行的每条指令中的地址都是虚拟内存地址</p>
</li>
<li><p>MMU会有一个表单，表单中，一边是虚拟内存地址，另一边是物理内存地址。RISC-V上一个叫做SATP的寄存器保存表单地址</p>
</li>
<li><p>MMU并不会保存page table，它只会从内存中读取page table，然后完成翻译</p>
</li>
<li><p>操作系统将CPU从一个应用程序切换到另一个应用程序时，同时也需要切换SATP寄存器中的内容，从而指向新的进程保存在物理内存中的地址对应表单。进程对应的SATP值是由内核保存，只有运行在kernel mode的代码可以更新这个寄存器。SATP呢？它存的是物理地址还是虚拟地址？物理地址</p>
</li>
<li><p>RISC-V中，一个page是4KB，也就是4096Bytes，为每个page创建一条表单条目</p>
</li>
<li><p>对于虚拟内存地址，划分为两个部分，index和offset，index用来查找page，offset对应的是一个page中的哪个字节。<br>MMU在做地址翻译，通过读取虚拟内存地址中的index可以知道物理内存中的page号，这个page号对应了物理内存中的4096个字节。之后虚拟内存地址中的offset指向了page中的4096个字节中的某一个，假设offset是12，那么page中的第12个字节被使用了。将offset加上page的起始地址，就可以得到物理内存地址</p>
</li>
<li><p>RISC-V的寄存器是64bit，虚拟内存地址的数量现在只有2^39个，大概是512GB，39bit中，有27bit被用来当做index，12bit被用来当做offset。offset必须是12bit，因为对应了一个page的4096个字节。</p>
</li>
<li><p>RISC-V中，物理内存地址是56bit，ARM v8也是？44bit是物理page号(PPN，Physical Page Number)，剩下12bit是offset完全继承自虚拟内存地址</p>
</li>
<li><p>增大页表？16k 64k？</p>
</li>
<li><p>多级页表，虚拟内存地址中的27bit的index，实际上是由3个9bit的数字组成(L2，L1，L0)。前9个bit被用来索引最高级的page directory</p>
</li>
<li><p>一个directory是4096Bytes，就跟page的大小是一样的。Directory中的一个条目被称为PTE（Page Table Entry）是64bits，就像寄存器的大小一样，也就是8Bytes。所以一个Directory page有512个条目。</p>
</li>
<li><p>SATP寄存器会指向最高一级的page directory的物理内存地址，虚拟内存中index的高9bit用来索引最高一级的page directory，这样我们就能得到一个PPN，也就是物理page号。这个PPN指向了中间级的page directory<br>最高级的page directory中的PPN，包含了下一级page directory的物理内存地址，依次类推。在最低级page directory，我们还是可以得到44bit的PPN，这里包含了我们实际上想要翻译的物理page地址，然后再加上虚拟内存地址的12bit offset，就得到了56bit物理内存地址</p>
</li>
<li><p>PTE中的Flag，因为它也很重要。每个PTE的低10bit是一堆标志位</p>
</li>
</ol>
<ul>
<li>第一个标志位是Valid。如果Valid bit位为1，那么表明这是一条合法的PTE</li>
<li>下两个标志位分别是Readable和Writable。表明你是否可以读/写这个page</li>
<li>Executable表明你可以从这个page执行指令</li>
<li>user表明这个page可以被运行在用户空间的进程访问。</li>
</ul>
<ol start="21">
<li>页表缓存(Translation Lookaside Buffer)<br>TLB会保存虚拟地址到物理地址的映射关系。<br>Q切换了page table，操作系统需要告诉处理器当前正在切换page table，处理器会清空TLB。在RISC-V中，清空TLB的指令是sfence_vma。<br>虚拟地址索引的cache位于MMU之前，由物理地址索引的cache位于MMU之后<br>在XV6中，内核有它自己的page table，用户进程也有自己的page table，用户进程指向sys_info结构体的指针存在于用户空间的page table，但是内核需要将这个指针翻译成一个自己可以读写的物理地址。copy_in，copy_out，你可以发现内核会通过用户进程的page table，将用户的虚拟地址翻译得到物理地址，这样内核可以读写相应的物理内存地址<br>page table提供了一层抽象(level of indirection)。抽象就是指从虚拟地址到物理地址的映射</li>
<li>当操作系统启动时，会从地址0x80000000开始运行，这个地址其实也是由硬件设计者决定的。地址0是保留的，地址0x10090000对应以太网，地址0x80000000对应DDR内存，处理器外的易失存储（Off-Chip Volatile Memory），也就是主板上的DRAM芯片</li>
<li>地址0x1000是boot ROM的物理地址，当你对主板上电，主板做的第一件事情就是运行存储在boot ROM中的代码，当boot完成之后，会跳转到地址0x80000000，操作系统需要确保那个地址有一些数据能够接着启动操作系统。</li>
<li>I/O设备</li>
</ol>
<ul>
<li>PLIC是中断控制器(Platform-Level Interrupt Controller)</li>
<li>CLINT(Core Local Interruptor)也是中断的一部分。所以多个设备都能产生中断，需要中断控制器来将这些中断路由到合适的处理函数</li>
<li>UART0（Universal Asynchronous Receiver/Transmitter）负责与Console和显示器交互</li>
<li>VIRTIO disk，与磁盘进行交互。</li>
</ul>
<ol start="25">
<li>同一个物理地址映射两个虚拟地址，你可以不将一个虚拟地址映射到物理地址。可以是一对一的映射，一对多映射，多对一映射</li>
<li>用户进程的虚拟地址空间分布<br><img src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20220717173502.png" alt="20220717173502"></li>
</ol>
<p>Kvminit函数<br>kvminithart函数<br>walk函数</p>
<h3 id="Armv8-A-Address-Translation"><a href="#Armv8-A-Address-Translation" class="headerlink" title="Armv8-A Address Translation"></a>Armv8-A Address Translation</h3><ol>
<li>支持4K、16K和64K页表。TCR_EL1寄存存储支持页表大小。</li>
<li>AArch64 4级页表，4K页表，48bit地址，9bit索引，512个表项，12bit的offset。<br><img src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20220724171523.png" alt="20220724171523"></li>
</ol>
<p>16K页表，11bit索引，2048表项，14bit的offset<br>64K页表，3级索引，<br>3. MMU 使用转换表和转换寄存器来控制哪些内存位置是可缓存。缓存策略MAIR_ELn寄存器标识，TLB缓存是否有效。</p>
<h3 id="DDI0487H-a-a-profile-architecture-reference-manual-pdf"><a href="#DDI0487H-a-a-profile-architecture-reference-manual-pdf" class="headerlink" title="DDI0487H_a_a-profile_architecture_reference_manual.pdf"></a>DDI0487H_a_a-profile_architecture_reference_manual.pdf</h3><h4 id="D5-2-6"><a href="#D5-2-6" class="headerlink" title="D5.2.6"></a>D5.2.6</h4><p>单一阶段转换：虚拟地址-&gt;物理地址<br>两阶段转换：虚拟地址-&gt;中间物理地址-&gt;物理地址</p>
<p>阶段1 </p>
<p><img src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20220724173718.png" alt="20220724173718"></p>
<h3 id="ARM64体系结构编程实践"><a href="#ARM64体系结构编程实践" class="headerlink" title="ARM64体系结构编程实践"></a>ARM64体系结构编程实践</h3><h4 id="第14章-内存管理"><a href="#第14章-内存管理" class="headerlink" title="第14章 内存管理"></a>第14章 内存管理</h4><h5 id="1"><a href="#1" class="headerlink" title="1"></a>1</h5><ol>
<li>进程地址空间使用内存3部分：进程本身、栈空间、堆空间</li>
<li>地址转换(address translation):进程请求虚拟地址(VA)转换为物理地址(PA)，通过MMU实现。</li>
<li>操作系统3元素：进程地址空间、进程的CPU虚拟化和文件对存储空间的抽象。</li>
<li>分页机制引入虚拟存储，核心思想让程序不使用的内存交换到磁盘中，程序正在使用内存保留在物理内存。</li>
<li>4K页帧虚拟地址组成VA[31:0]，偏移量offset VA[11:0]; 虚拟页帧号(VPN)。物理地址组成，偏移量offset PA[11:0];物理页帧号(PFN)。MMU把虚拟页帧号转换成物理页帧号。</li>
<li>页表：存储VPN到PFN的映射关系，表项称为页表项PTE。多级页表用来减少页表占用内存空间，ARM64v8支持4级页表。</li>
<li>TLB未命中从，处理器MMU中页表查询</li>
</ol>
<ul>
<li>处理器根据虚拟地址判断使用TTBR0还是TTBR1，虚拟地址第63位为1时，选择TTBR1，为0时，选择TTBR0。TTBR中存储一级页表(L0)基地址。</li>
<li>处理器以虚拟地址一级索引在一级页表中查找表项。</li>
</ul>
<ol start="8">
<li>ARM64 处理器的MMU包括TLB和页表遍历单元。TLB是高速缓存，用于缓存页表转换的结果。</li>
<li>进程地址空间分为：内核空间(kernel space)和用户空间(user space)</li>
<li>SMP多核处理器系统中，每个处理器内置MMU和TLB，如何保证CPU访问正前有效的TLB。</li>
<li>AArach64体系结构页表特性：</li>
</ol>
<ul>
<li>最多支持4级页表</li>
<li>输入地址最多有效位宽为48bit</li>
<li>输出地址最大有效位款为48bit</li>
<li>页帧大小支持4KB、16KB和64KB</li>
</ul>
<ol start="12">
<li><p>AArach64采用两套页表设计，虚拟地址空间分为三部分：下面是用户空间，中间是非规范区，上面是内核空间。当CPU访问用户空间是，MMU选择TTBR0指向的页表，CPU访问内核空间时，MMU选择TTBR1寄存器指向的页表。</p>
</li>
<li><p>页表属性</p>
</li>
</ol>
<ul>
<li>共享性与缓存性：共享性决定高速缓存可被哪些观察者观察到; 缓存性值页面是否使能高速缓存以及高速缓存的范围。</li>
<li>访问权限：AP字段控制CPU对页面的访问，可读可写属性。</li>
<li>执行权限：PXN字段以及XN/UXN字段设置CPU是否可执行页面</li>
<li>访问标志位：访问字段AF用来标识页面是否被访问过。</li>
<li>全局和进程特有TLB：nG字段，0全局，1进程特有</li>
</ul>
<ol start="14">
<li><p>硬件管理访问位和脏位(TTHM特性)，页表转换控制器TCR，HA字段自动设置AF标志。<br>脏位TCR_EL1的HD字段，</p>
</li>
<li><p>转换控制寄存器(TCR)、系统控制寄存器(SCTLR)和转换页表基址寄存器(TTBR)。<br>TTBR中ASID字段用来存储硬件ASID，AADDR字段存储页表基地址。</p>
</li>
<li><p>内存属性：Armv8两种内存属性：普通类型内存和设备内存。普通内存可优化。设备内存不可预测访问。</p>
</li>
</ol>
<h2 id="Calling-conventions-and-stack-frames-RISC-V"><a href="#Calling-conventions-and-stack-frames-RISC-V" class="headerlink" title="Calling conventions and stack frames RISC-V"></a>Calling conventions and stack frames RISC-V</h2><ul>
<li>syscanll  lab</li>
<li>C -&gt; Asm / Processor</li>
<li>RISC-V &amp; x86 &amp; Arm64</li>
<li>Registers</li>
<li>stack + calling conventions</li>
<li>struct layout in memory</li>
</ul>
<h3 id="编译，RISV-V调用规范"><a href="#编译，RISV-V调用规范" class="headerlink" title="编译，RISV-V调用规范"></a>编译，RISV-V调用规范</h3><p> ISA就是处理器能够理解的指令集。每一条指令都有一个对应的二进制编码或者一个Opcode。<br> 预处理-编译-汇编-链接<br> RISC精简指令集与CISC复杂指令集，RISC统一的加载与存储指令。<br> RISC-V指令包含Base Integer Instruction Set和Standard Extension Instruction Set<br> 汇编代码：global全局变量函数，text代码段<br>进程地址空间<br><img src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20220731191036.png" alt="20220731191036"><br> gdb layout split会同时展现C代码和汇编，而layout source只会展示C代码。</p>
<h3 id="RISC-V寄存器"><a href="#RISC-V寄存器" class="headerlink" title="RISC-V寄存器"></a>RISC-V寄存器</h3><p><img src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20220731191509.png" alt="20220731191509"></p>
<ul>
<li>Caller Saved寄存器在函数调用的时候不会保存</li>
<li>Callee Saved寄存器在函数调用的时候会保存<br> 汇编代码并不是在内存上执行，而是在寄存器上执行，load到寄存器，store到其他地方。除了Compressed Instruction，寄存器都是通过它们的ABI名字来引用。<br> a0到a7寄存器是用来作为函数的参数。如果一个函数有超过8个参数，需要用内存</li>
</ul>
<h3 id="Stack"><a href="#Stack" class="headerlink" title="Stack"></a>Stack</h3><p>Stack Frame<br><img src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20220731192550.png" alt="20220731192550"><br>函数通过移动Stack Pointer来完成Stack Frame的空间分配。</p>
<ul>
<li>Return address总是会出现在Stack Frame的第一位</li>
<li>指向前一个Stack Frame的指针也会出现在栈中的固定位置<br>第一个是SP（Stack Pointer），指向Stack的底部并代表了当前Stack Frame的位置。第二个是FP（Frame Pointer），它指向当前Stack Frame的顶部。因为Return address和指向前一个Stack Frame的的指针都在当前Stack Frame的固定位置，所以可以通过当前的FP寄存器寻址到这两个数据。?  前一个Frame Pointer存储到FP寄存器<br> leaf函数是指不调用别的函数的函数,不用担心保存自己的Return address或者任何其他的Caller Saved寄存器<br> 删除掉Prologue和Epllogue? sum_then_double将不知道它应该返回的Return address。所以调用sum_to的时候，Return address被覆盖了，最终sum_to函数不能返回到它原本的调用位置。</li>
</ul>
<p> info frame</p>
<ul>
<li>Stack level 0，表明这是调用栈的最底层</li>
<li>pc，当前的程序计数器</li>
<li>saved pc，demo4的位置，表明当前函数要返回的位置</li>
<li>source language c，表明这是C代码</li>
<li>Arglist at，表明参数的起始地址。当前的参数都在寄存器中，可以看到argc=3，argv是一个地址</li>
</ul>
<h3 id="Struct"><a href="#Struct" class="headerlink" title="Struct"></a>Struct</h3><h2 id="Isolation-amp-system-call-entry-exit-Rebort"><a href="#Isolation-amp-system-call-entry-exit-Rebort" class="headerlink" title="Isolation &amp; system call entry/exit(Rebort)"></a>Isolation &amp; system call entry/exit(Rebort)</h2><br>
<br>

<p>b站课程：<br><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV19k4y1C7kA?p=2&amp;spm_id_from=pageDriver&amp;vd_source=6768732acbd0f78ac59230d2faa59a86">https://www.bilibili.com/video/BV19k4y1C7kA?p=2&amp;spm_id_from=pageDriver&amp;vd_source=6768732acbd0f78ac59230d2faa59a86</a></p>
<p>课程翻译<br><a target="_blank" rel="noopener" href="https://github.com/huihongxiao/MIT6.S081">https://github.com/huihongxiao/MIT6.S081</a><br><a target="_blank" rel="noopener" href="https://mit-public-courses-cn-translatio.gitbook.io/mit6-s081/">https://mit-public-courses-cn-translatio.gitbook.io/mit6-s081/</a></p>
<p><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2020/schedule.html">https://pdos.csail.mit.edu/6.828/2020/schedule.html</a></p>
<p><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2020/schedule.html">https://pdos.csail.mit.edu/6.828/2020/schedule.html</a></p>
<script type="text&#x2F;javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.7.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.7.0/dist/mindmap.min.css">
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Another-Tag/" rel="tag"># Another Tag</a>
              <a href="/tags/Computer-Science/" rel="tag"># Computer Science</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/05/20/2022/Dynamorio/" rel="prev" title="Dynamorio">
      <i class="fa fa-chevron-left"></i> Dynamorio
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/07/15/2022/%E7%8E%B0%E4%BB%A3%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" rel="next" title="现代操作系统">
      现代操作系统 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-OS-Organization-and-System-Calls"><span class="nav-text">3 OS Organization and System Calls</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Page-Table"><span class="nav-text">Page Table</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Armv8-A-Address-Translation"><span class="nav-text">Armv8-A Address Translation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DDI0487H-a-a-profile-architecture-reference-manual-pdf"><span class="nav-text">DDI0487H_a_a-profile_architecture_reference_manual.pdf</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#D5-2-6"><span class="nav-text">D5.2.6</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ARM64%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84%E7%BC%96%E7%A8%8B%E5%AE%9E%E8%B7%B5"><span class="nav-text">ARM64体系结构编程实践</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC14%E7%AB%A0-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="nav-text">第14章 内存管理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1"><span class="nav-text">1</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Calling-conventions-and-stack-frames-RISC-V"><span class="nav-text">Calling conventions and stack frames RISC-V</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%EF%BC%8CRISV-V%E8%B0%83%E7%94%A8%E8%A7%84%E8%8C%83"><span class="nav-text">编译，RISV-V调用规范</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RISC-V%E5%AF%84%E5%AD%98%E5%99%A8"><span class="nav-text">RISC-V寄存器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Stack"><span class="nav-text">Stack</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Struct"><span class="nav-text">Struct</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Isolation-amp-system-call-entry-exit-Rebort"><span class="nav-text">Isolation &amp; system call entry&#x2F;exit(Rebort)</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">19</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2021 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">276k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">4:11</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>



<div>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv" style='display:none'>
    本站总访问量 <span id="busuanzi_value_site_pv"></span> 次
    <span class="post-meta-divider">|</span>
</span>
<span id="busuanzi_container_site_uv" style='display:none'>
    有<span id="busuanzi_value_site_uv"></span>人看过我的博客啦
</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
